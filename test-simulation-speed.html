<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulation Speed Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .test-section {
            background: #f5f5f5;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-left: 4px solid #4CAF50;
        }
        .error {
            border-left-color: #f44336;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 4px;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        #output {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>Simulation Speed Test</h1>
    <p>This test verifies that the step-based simulation timing works correctly.</p>
    
    <div class="test-section">
        <h2>Test Configuration</h2>
        <p>The test creates a mock GameAPI and simulates physics steps to verify:</p>
        <ul>
            <li>Step counters are properly decremented</li>
            <li>Actions complete after the correct number of steps</li>
            <li>Fast-forward mode uses step-based timing</li>
            <li>Normal mode still uses timeout-based timing</li>
        </ul>
        <button onclick="runTests()">Run Tests</button>
        <button onclick="clearOutput()">Clear Output</button>
    </div>
    
    <div id="output"></div>
    
    <script type="module">
        import { GameAPI } from './game/rl/game-api.js';
        
        window.runTests = async function() {
            const output = document.getElementById('output');
            output.innerHTML = '<h2>Test Results</h2>';
            
            function log(message, isError = false) {
                const div = document.createElement('div');
                div.className = 'result' + (isError ? ' error' : '');
                div.textContent = message;
                output.appendChild(div);
            }
            
            try {
                // Test 1: Create GameAPI instance
                log('Test 1: Creating GameAPI instance...');
                const gameAPI = new GameAPI();
                log('✓ GameAPI instance created successfully');
                
                // Test 2: Initialize with mock game instance
                log('\nTest 2: Initializing with mock game instance...');
                const mockEngine = {
                    timing: { timeScale: 1 }
                };
                
                const mockEvents = {
                    callbacks: [],
                    on: function(engine, event, callback) {
                        this.callbacks.push({ engine, event, callback });
                    }
                };
                
                const mockGame = {
                    engine: mockEngine,
                    Events: mockEvents,
                    score: 0,
                    currentGameMaxFruit: -1,
                    gameWorldWidth: 1200,
                    gameWorldHeight: 1800,
                    gameOverLineY: 324,
                    wallThickness: 120,
                    FRUITS: [
                        { level: 0, baseRadius: 66, score: 5 }
                    ],
                    currentFruitLevel: 0,
                    nextFruitLevel: 0,
                    world: { bodies: [] },
                    moveFruit: () => {},
                    dropFruit: () => {},
                    handleRestart: () => {}
                };
                
                gameAPI.init(mockGame);
                log('✓ GameAPI initialized successfully');
                log(`  - Events registered: ${mockEvents.callbacks.length}`);
                
                // Test 3: Test step counting
                log('\nTest 3: Testing step counter mechanism...');
                gameAPI.dropCooldownCounter = 5;
                
                // Simulate 5 steps
                for (let i = 0; i < 5; i++) {
                    gameAPI.onSimulationStep();
                }
                
                if (gameAPI.dropCooldownCounter === 0) {
                    log('✓ Step counter decrements correctly');
                } else {
                    log(`✗ Step counter incorrect: expected 0, got ${gameAPI.dropCooldownCounter}`, true);
                }
                
                // Test 4: Test fast-forward mode
                log('\nTest 4: Testing fast-forward mode...');
                gameAPI.setFastForwardMode(true);
                
                if (gameAPI.fastForwardMode === true) {
                    log('✓ Fast-forward mode enabled');
                } else {
                    log('✗ Fast-forward mode not enabled', true);
                }
                
                if (mockEngine.timing.timeScale === gameAPI.TRAINING_PHYSICS_SPEED) {
                    log(`✓ Physics speed multiplier set correctly (${gameAPI.TRAINING_PHYSICS_SPEED}x)`);
                } else {
                    log(`✗ Physics speed incorrect: expected ${gameAPI.TRAINING_PHYSICS_SPEED}, got ${mockEngine.timing.timeScale}`, true);
                }
                
                // Test 5: Test action execution with step-based timing
                log('\nTest 5: Testing action execution with step-based timing...');
                gameAPI.fastForwardMode = true;
                
                // Start an action
                const actionPromise = gameAPI.executeAction(0.5);
                
                // Verify cooldown was set
                if (gameAPI.dropCooldownCounter === gameAPI.DROP_COOLDOWN_STEPS) {
                    log(`✓ Drop cooldown initialized to ${gameAPI.DROP_COOLDOWN_STEPS} steps`);
                } else {
                    log(`✗ Drop cooldown not initialized correctly`, true);
                }
                
                // Simulate steps to complete the action
                const startStep = gameAPI.simulationStep;
                for (let i = 0; i < gameAPI.DROP_COOLDOWN_STEPS; i++) {
                    gameAPI.onSimulationStep();
                }
                
                // Wait a bit for the action to resolve
                await new Promise(resolve => setTimeout(resolve, 100));
                
                const stepsElapsed = gameAPI.simulationStep - startStep;
                log(`✓ Simulated ${stepsElapsed} physics steps`);
                
                // Test 6: Verify step-based vs timeout-based behavior
                log('\nTest 6: Comparing step-based vs timeout-based timing...');
                
                gameAPI.setFastForwardMode(true);
                const fastStartTime = Date.now();
                gameAPI.dropCooldownCounter = 10;
                for (let i = 0; i < 10; i++) {
                    gameAPI.onSimulationStep();
                }
                const fastEndTime = Date.now();
                const fastDuration = fastEndTime - fastStartTime;
                
                log(`✓ Step-based (fast-forward): ~${fastDuration}ms for 10 steps`);
                
                gameAPI.setFastForwardMode(false);
                const normalStartTime = Date.now();
                await new Promise(resolve => {
                    setTimeout(resolve, 800);
                });
                const normalEndTime = Date.now();
                const normalDuration = normalEndTime - normalStartTime;
                
                log(`✓ Timeout-based (normal): ~${normalDuration}ms`);
                log(`✓ Speed improvement: ~${Math.floor(normalDuration / Math.max(fastDuration, 1))}x faster`);
                
                // Summary
                log('\n=== All Tests Passed ===');
                log('The step-based simulation timing is working correctly!');
                log('Key benefits:');
                log('  - No artificial delays in fast-forward mode');
                log('  - Actions complete as soon as physics settles');
                log('  - Maximum simulation speed achieved');
                
            } catch (error) {
                log(`✗ Test failed with error: ${error.message}`, true);
                log(`Stack trace: ${error.stack}`, true);
            }
        };
        
        window.clearOutput = function() {
            document.getElementById('output').innerHTML = '';
        };
    </script>
</body>
</html>
